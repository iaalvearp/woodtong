---
import LayoutPrincipal from "../../layouts/LayoutPrincipal.astro";

// Interfaces de TypeScript para D1
interface Mueble {
    id_mueble: number;
    nombre: string;
    descripcion: string;
    precio: number;
    url_imagen: string;
    categoria: string;
    orden_hero: number;
}

interface Prospecto {
    id_prospecto: number;
    nombre_completo: string;
    correo: string;
    telefono: string;
    id_cupon: string;
    fecha: string;
}

const db = Astro.locals.runtime?.env?.DB;

if (!db) {
    throw new Error("Database not available. Check Cloudflare D1 binding configuration in Cloudflare Pages dashboard.");
}

// Verificar autenticación desde el middleware
const usuario = Astro.locals.usuario;
const esAdmin = usuario?.rol === "admin";

// Consultas reales a D1
const { results: mueblesRaw } = await db
	.prepare("SELECT * FROM Muebles ORDER BY id_mueble DESC")
	.all();
const { results: prospectosRaw } = await db
	.prepare("SELECT * FROM Prospectos ORDER BY fecha DESC")
	.all();

const muebles = mueblesRaw as unknown as Mueble[];
const prospectos = prospectosRaw as unknown as Prospecto[];
---

<LayoutPrincipal titulo="Administración">
	{
		!esAdmin ? (
			<div class="acceso-denegado">
				<div class="mensaje-denegado">
					<span class="material-symbols-outlined">lock</span>
					<h1>Acceso Restringido</h1>
					<p>Esta área requiere permisos de administrador.</p>
					<a href="/login" class="btn-login-link">Iniciar Sesión</a>
				</div>
			</div>
		) : (
    <div class="admin-container">
        <header class="admin-header revelar-arriba">
            <h1>Panel de Control</h1>
            <p>Gestión de inventario y prospectos comerciales.</p>
        </header>

        <div class="tabs-container revelar-arriba">
            <div class="tabs-buttons" id="tabs-btns">
                <button class="tab-btn activo" data-tab="inventario"
                    >Inventario</button
                >
                <button class="tab-btn" data-tab="prospectos">Prospectos</button
                >
            </div>

            <div class="tab-content">
                <!-- Inventario -->
                <div class="tab-pane activo" id="tab-inventario">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Categoría</th>
                                    <th>Precio</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {
                                    muebles.map((m: any) => (
                                        <tr data-id={m.id_mueble}>
                                            <td>{m.id_mueble}</td>
                                            <td
                                                class="editable"
                                                data-col="nombre"
                                            >
                                                {m.nombre}
                                            </td>
                                            <td
                                                class="editable"
                                                data-col="categoria"
                                            >
                                                {m.categoria}
                                            </td>
                                            <td
                                                class="editable"
                                                data-col="precio"
                                            >
                                                ${m.precio}
                                            </td>
                                            <td>
                                                <div class="acciones-fila">
                                                    <button class="btn-editar">
                                                        Editar
                                                    </button>
                                                    <span class="status-icon" />
                                                </div>
                                            </td>
                                        </tr>
                                    ))
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Prospectos -->
                <div class="tab-pane" id="tab-prospectos">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Correo</th>
                                    <th>Cupón</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody>
                                {
                                    prospectos.map((p: any) => (
                                        <tr>
                                            <td>{p.id_prospecto}</td>
                                            <td>{p.nombre_completo}</td>
                                            <td>{p.correo}</td>
                                            <td>{p.id_cupon || "---"}</td>
                                            <td>
                                                {new Date(
                                                    p.fecha,
                                                ).toLocaleDateString()}
                                            </td>
                                        </tr>
                                    ))
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    )}

    <!-- Modal Formulario Dinámico (Simulado) -->
    <div class="modal-admin" id="modal-admin">
        <div class="modal-content-admin">
            <h2 id="modal-titulo">Editar Registro</h2>
            <form id="form-dinamico">
                <!-- Los campos se generan dinámicamente con JS -->
                <div id="campos-dinamicos"></div>
                <div class="form-acciones">
                    <button type="button" id="btn-cancelar">Cancelar</button>
                    <button type="submit" class="btn-guardar"
                        >Guardar Cambios</button
                    >
                </div>
            </form>
        </div>
    </div>
</LayoutPrincipal>

<script>
    import { actions } from "astro:actions";

    // Lógica de Pestañas
    const btns = document.querySelectorAll(".tab-btn");
    const panes = document.querySelectorAll(".tab-pane");

    btns.forEach((btn) => {
        btn.addEventListener("click", () => {
            const target = btn.getAttribute("data-tab");
            btns.forEach((b) => b.classList.remove("activo"));
            panes.forEach((p) => p.classList.remove("activo"));
            btn.classList.add("activo");
            document.getElementById(`tab-${target}`)?.classList.add("activo");
        });
    });

    // Lógica de Edición y Formulario Dinámico
    const modal = document.getElementById("modal-admin");
    const formDinamico = document.getElementById(
        "form-dinamico",
    ) as HTMLFormElement;
    const camposDinamicos = document.getElementById("campos-dinamicos");
    const btnCancelar = document.getElementById("btn-cancelar");
    let idActual: number | null = null;
    let filaActual: HTMLTableRowElement | null = null;

    document.querySelectorAll(".btn-editar").forEach((btn) => {
        btn.addEventListener("click", (e) => {
            filaActual = (e.target as HTMLElement).closest("tr");
            if (!filaActual) return;

            idActual = parseInt(filaActual.getAttribute("data-id") || "0");
            const data = {
                nombre: filaActual.querySelector('[data-col="nombre"]')
                    ?.textContent,
                categoria: filaActual.querySelector('[data-col="categoria"]')
                    ?.textContent,
                precio: filaActual
                    .querySelector('[data-col="precio"]')
                    ?.textContent?.replace("$", ""),
            };

            if (camposDinamicos) {
                camposDinamicos.innerHTML = Object.entries(data)
                    .map(
                        ([key, val]) => `
                    <div class="campo">
                        <label>${key.charAt(0).toUpperCase() + key.slice(1)}</label>
                        <input type="${key === "precio" ? "number" : "text"}" name="${key}" value="${val}" required />
                    </div>
                `,
                    )
                    .join("");
            }

            modal?.classList.add("activo");
        });
    });

    formDinamico?.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!idActual || !filaActual) return;

        const formData = new FormData(formDinamico);
        const nuevoNombre = formData.get("nombre") as string;
        const nuevaCategoria = formData.get("categoria") as string;
        const nuevoPrecio = parseFloat(formData.get("precio") as string);

        const statusIcon = filaActual.querySelector(".status-icon");
        const btnGuardar = formDinamico.querySelector(
            ".btn-guardar",
        ) as HTMLButtonElement;

        // Visual Feedback: Guardando
        if (statusIcon) statusIcon.innerHTML = "⌛";
        btnGuardar.disabled = true;
        btnGuardar.textContent = "Guardando...";

        const { error } = await actions.actualizarInventario({
            idMueble: idActual,
            nuevoNombre,
            nuevaCategoria,
            nuevoPrecio,
        });

        if (!error) {
            // Actualizar UI
            filaActual.querySelector('[data-col="nombre"]')!.textContent =
                nuevoNombre;
            filaActual.querySelector('[data-col="categoria"]')!.textContent =
                nuevaCategoria;
            filaActual.querySelector('[data-col="precio"]')!.textContent =
                `$${nuevoPrecio}`;

            // Visual Feedback: Éxito
            if (statusIcon) {
                statusIcon.innerHTML = "✅";
                statusIcon.classList.add("exito");
                setTimeout(() => {
                    statusIcon.innerHTML = "";
                    statusIcon.classList.remove("exito");
                }, 3000);
            }
            modal?.classList.remove("activo");
        } else {
            if (statusIcon) statusIcon.innerHTML = "❌";
            alert("Error al actualizar");
        }

        btnGuardar.disabled = false;
        btnGuardar.textContent = "Guardar Cambios";
    });

    btnCancelar?.addEventListener("click", () =>
        modal?.classList.remove("activo"),
    );
</script>

<style>
    .admin-container {
        max-width: 1200px;
        margin: 8rem auto 4rem;
        padding: 0 1.5rem;
        background: transparent;
        border-radius: 1.5rem;
    }

    .admin-header {
        margin-bottom: 3rem;
        padding: 2rem;
    }

    .admin-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--texto-primario-50);
    }

    .admin-header p {
        color: var(--texto-primario-200);
    }

    /* Acceso Denegado Styles */
    .acceso-denegado {
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 2rem;
    }

    .admin-container {
        max-width: 1200px;
        margin: 8rem auto 4rem;
        padding: 0 1.5rem;
        border-radius: 1.5rem;
    }

    .mensaje-denegado {
        background: var(--gris-apple);
        padding: 3rem;
        border-radius: 2rem;
        max-width: 400px;
        box-shadow: 0 10px 30px var(--sombra-suave);
    }

    .mensaje-denegado span {
        font-size: 4rem;
        color: var(--primario);
        margin-bottom: 1rem;
    }

    .mensaje-denegado h1 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        color: var(--oscuro);
    }

    .hint {
        display: block;
        margin-top: 2rem;
        font-size: 0.75rem;
        color: var(--texto-secundario);
        background: rgba(0, 0, 0, 0.05);
        padding: 0.5rem;
        border-radius: 0.5rem;
    }

    .tabs-buttons {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        background: var(--blanco);
        padding: 0.5rem;
        border-radius: 1rem;
        width: fit-content;
    }

    .tab-btn {
        background: none;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 0.75rem;
        font-weight: 600;
        color: var(--texto-secundario);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .tab-btn.activo {
        background: var(--blanco);
        color: var(--oscuro);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .tab-pane {
        display: none;
    }

    .tab-pane.activo {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    .table-wrapper {
        background: var(--blanco);
        border-radius: 1.5rem;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 4px 20px var(--sombra-suave);
        padding: 1rem;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        text-align: left;
    }

    th {
        background: var(--gris-apple);
        padding: 1.25rem 1.5rem;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--texto-secundario);
        letter-spacing: 0.05em;
    }

    td {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.03);
        font-size: 0.9375rem;
    }

    .btn-editar {
        background: var(--gris-apple);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .btn-editar:hover {
        background: #e1e1e3;
    }

    .acciones-fila {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-icon {
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .status-icon.exito {
        color: #064c39;
        transform: scale(1.2);
    }

    /* Modal Admin Style */
    .modal-admin {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(8px);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .modal-admin.activo {
        display: flex;
    }

    .modal-content-admin {
        background: var(--blanco);
        width: 100%;
        max-width: 450px;
        padding: 2.5rem;
        border-radius: 2rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    #form-dinamico .campo {
        margin-bottom: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    #form-dinamico label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--texto-secundario);
    }

    #form-dinamico input {
        padding: 0.875rem 1.25rem;
        border-radius: 1rem;
        border: 1px solid rgba(0, 0, 0, 0.1);
        background: var(--gris-apple);
        outline: none;
        font-size: 1rem;
    }

    .form-acciones {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    #btn-cancelar {
        flex: 1;
        padding: 1rem;
        border-radius: 1rem;
        border: none;
        background: var(--gris-apple);
        font-weight: 600;
        cursor: pointer;
    }

    .btn-guardar {
        flex: 2;
        padding: 1rem;
        border-radius: 1rem;
        border: none;
        background: var(--primario);
        color: var(--blanco);
        font-weight: 700;
        cursor: pointer;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
